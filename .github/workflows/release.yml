name: Build and Release

on:
  workflow_run:
    workflows: ["Auto Version Bump"]
    types:
      - completed
  workflow_dispatch:
    inputs:
      version:
        description: "Version to release (e.g., 1.2.3 or v1.2.3)"
        required: false

permissions:
  contents: write

concurrency:
  group: release-${{ github.ref_name || inputs.version || github.run_id }}
  cancel-in-progress: false

jobs:
  verify-tag:
    name: Verify Release Tag
    runs-on: ubuntu-latest
    if: |
      github.event_name == 'workflow_dispatch' ||
      (github.event_name == 'workflow_run' && github.event.workflow_run.conclusion == 'success')
    outputs:
      tag: ${{ steps.meta.outputs.tag }}
      version: ${{ steps.meta.outputs.version }}
      prerelease: ${{ steps.meta.outputs.prerelease }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Resolve release metadata
        id: meta
        shell: bash
        run: |
          if [[ -n "${{ inputs.version }}" ]]; then
            RAW="${{ inputs.version }}"
            TAG="${RAW#v}"
            TAG="v${TAG}"
          else
            VERSION=$(node -p "require('./package.json').version")
            TAG="v${VERSION}"
          fi

          VERSION="${TAG#v}"
          PRERELEASE="false"
          if [[ "$VERSION" == *"-"* ]]; then
            PRERELEASE="true"
          fi

          echo "tag=${TAG}" >> "$GITHUB_OUTPUT"
          echo "version=${VERSION}" >> "$GITHUB_OUTPUT"
          echo "prerelease=${PRERELEASE}" >> "$GITHUB_OUTPUT"
          echo "Resolved release tag: ${TAG}"

      - name: Verify tag exists
        shell: bash
        run: |
          TAG="${{ steps.meta.outputs.tag }}"
          git fetch --tags --force

          if ! git rev-parse "refs/tags/${TAG}" >/dev/null 2>&1; then
            echo "::error::Release tag '${TAG}' not found. Make sure Auto Version Bump created and pushed the tag."
            exit 1
          fi

  test:
    name: Run Tests
    runs-on: ubuntu-latest
    needs: verify-tag
    if: |
      github.event_name == 'workflow_dispatch' ||
      (github.event_name == 'workflow_run' && github.event.workflow_run.conclusion == 'success')

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup .NET 8
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: "8.0.x"

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"

      - name: Restore .NET dependencies
        run: dotnet restore

      - name: Build .NET
        run: dotnet build --no-restore --configuration Release

      - name: Run .NET tests
        run: dotnet test --no-build --configuration Release --verbosity normal

      - name: Install root dependencies
        run: npm ci

      - name: Install frontend dependencies
        working-directory: frontend
        run: npm ci

      - name: Run frontend tests
        working-directory: frontend
        run: npm run test:run

  build:
    name: Build ${{ matrix.os }} (${{ matrix.arch }})
    needs: test
    runs-on: ${{ matrix.runner }}

    strategy:
      fail-fast: false
      matrix:
        include:
          - os: windows
            runner: windows-latest
            arch: x64
            dotnet-runtime: win-x64
          - os: macos
            runner: macos-14
            arch: arm64
            dotnet-runtime: osx-arm64
          - os: linux
            runner: ubuntu-latest
            arch: x64
            dotnet-runtime: linux-x64

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"

      - name: Setup .NET 8
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: "8.0.x"

      - name: Install root dependencies
        run: npm ci

      - name: Install frontend dependencies
        working-directory: frontend
        run: npm ci

      - name: Build React app
        run: npm run build:react:electron

      - name: Build .NET backend
        run: dotnet publish PetHotel.API/PetHotel.API.csproj -c Release -r ${{ matrix.dotnet-runtime }} --self-contained -o PetHotel.API/out

      - name: Build Electron (Windows)
        if: matrix.os == 'windows'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: npx electron-builder --win --x64 --publish never

      - name: Build Electron (macOS)
        if: matrix.os == 'macos'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          if [ "${{ matrix.arch }}" = "arm64" ]; then
            npx electron-builder --mac --arm64 --publish never
          else
            npx electron-builder --mac --x64 --publish never
          fi

      - name: Build Electron (Linux)
        if: matrix.os == 'linux'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: npx electron-builder --linux --x64 --publish never

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.os }}-${{ matrix.arch }}-build
          path: |
            dist-electron/*.exe
            dist-electron/*.dmg
            dist-electron/*.zip
            dist-electron/*.AppImage
            dist-electron/*.deb
            dist-electron/*.yml
          retention-days: 7

  release:
    name: Create Release
    needs: [build, verify-tag]
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ needs.verify-tag.outputs.tag }}
          name: Release ${{ needs.verify-tag.outputs.tag }}
          draft: false
          prerelease: ${{ needs.verify-tag.outputs.prerelease == 'true' }}
          generate_release_notes: true
          files: |
            artifacts/**/*.exe
            artifacts/**/*.dmg
            artifacts/**/*.zip
            artifacts/**/*.AppImage
            artifacts/**/*.deb
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
