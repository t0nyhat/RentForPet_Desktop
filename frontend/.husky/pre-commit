#!/usr/bin/env sh
. "$(dirname -- "$0")/_/husky.sh"

# –°–æ—Ö—Ä–∞–Ω—è–µ–º –∫–æ—Ä–Ω–µ–≤—É—é –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é –ø—Ä–æ–µ–∫—Ç–∞
PROJECT_ROOT="$(cd "$(dirname -- "$0")/../.." && pwd)"

echo "üöÄ –ó–∞–ø—É—Å–∫ pre-commit –ø—Ä–æ–≤–µ—Ä–æ–∫..."
echo ""

# ============================================
# FRONTEND –ü–†–û–í–ï–†–ö–ò
# ============================================
cd "$PROJECT_ROOT/frontend" || exit 1

# 1. Lint-staged (ESLint + Prettier –¥–ª—è –∏–∑–º–µ–Ω–µ–Ω–Ω—ã—Ö —Ñ–∞–π–ª–æ–≤)
echo "üìù [Frontend] –ü—Ä–æ–≤–µ—Ä–∫–∞ ESLint –∏ Prettier (lint-staged)..."
npx lint-staged || {
  echo "‚ùå ESLint –∏–ª–∏ Prettier –ø—Ä–æ–≤–µ—Ä–∫–∞ –Ω–µ –ø—Ä–æ–π–¥–µ–Ω–∞!"
  exit 1
}
echo "‚úÖ [Frontend] ESLint –∏ Prettier –ø—Ä–æ—à–ª–∏ –ø—Ä–æ–≤–µ—Ä–∫—É"
echo ""

# 2. TypeScript type checking
echo "üîç [Frontend] –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ç–∏–ø–æ–≤ TypeScript..."
npm run type-check || {
  echo "‚ùå TypeScript –ø—Ä–æ–≤–µ—Ä–∫–∞ —Ç–∏–ø–æ–≤ –Ω–µ –ø—Ä–æ–π–¥–µ–Ω–∞!"
  exit 1
}
echo "‚úÖ [Frontend] TypeScript —Ç–∏–ø—ã –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã"
echo ""

# 3. Frontend tests
echo "üß™ [Frontend] –ó–∞–ø—É—Å–∫ —Ç–µ—Å—Ç–æ–≤..."
npm test -- --run || {
  echo "‚ùå Frontend —Ç–µ—Å—Ç—ã –Ω–µ –ø—Ä–æ–π–¥–µ–Ω—ã!"
  exit 1
}
echo "‚úÖ [Frontend] –í—Å–µ —Ç–µ—Å—Ç—ã –ø—Ä–æ–π–¥–µ–Ω—ã"
echo ""

# ============================================
# BACKEND –ü–†–û–í–ï–†–ö–ò (C#)
# ============================================
cd "$PROJECT_ROOT" || exit 1

# –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ –∏–∑–º–µ–Ω–µ–Ω–Ω—ã–µ C# —Ñ–∞–π–ª—ã
CS_FILES=$(git diff --cached --name-only --diff-filter=ACM | grep '\.cs$' || true)

if [ -n "$CS_FILES" ]; then
  echo "üîç [Backend] –û–±–Ω–∞—Ä—É–∂–µ–Ω—ã –∏–∑–º–µ–Ω–µ–Ω–Ω—ã–µ C# —Ñ–∞–π–ª—ã, –∑–∞–ø—É—Å–∫ –ø—Ä–æ–≤–µ—Ä–æ–∫..."
  
  # 4. StyleCop + Build
  echo "üìù [Backend] –ü—Ä–æ–≤–µ—Ä–∫–∞ StyleCop –∏ —Å–±–æ—Ä–∫–∞ –ø—Ä–æ–µ–∫—Ç–∞..."
  BUILD_OUTPUT=$(dotnet build --no-incremental 2>&1)
  BUILD_EXIT=$?
  
  # –ü–æ–¥—Å—á–∏—Ç—ã–≤–∞–µ–º –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏—è StyleCop
  STYLECOP_WARNINGS=$(echo "$BUILD_OUTPUT" | grep -c "warning SA" || true)
  
  if [ $BUILD_EXIT -ne 0 ]; then
    echo "‚ùå C# —Å–±–æ—Ä–∫–∞ –Ω–µ –ø—Ä–æ–π–¥–µ–Ω–∞!"
    echo "$BUILD_OUTPUT"
    exit 1
  fi
  
  if [ $STYLECOP_WARNINGS -gt 0 ]; then
    echo "‚ö†Ô∏è  –ù–∞–π–¥–µ–Ω–æ $STYLECOP_WARNINGS –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–π StyleCop:"
    echo "$BUILD_OUTPUT" | grep "warning SA" | head -20
    echo ""
    echo "üí° –ò—Å–ø—Ä–∞–≤—å—Ç–µ –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏—è StyleCop –∏–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ 'git commit --no-verify' –¥–ª—è –ø—Ä–æ–ø—É—Å–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏"
    exit 1
  fi
  
  echo "‚úÖ [Backend] StyleCop –∏ —Å–±–æ—Ä–∫–∞ –ø—Ä–æ—à–ª–∏ —É—Å–ø–µ—à–Ω–æ (0 –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–π)"
  echo ""
  
  # 5. Backend tests
  echo "üß™ [Backend] –ó–∞–ø—É—Å–∫ —Ç–µ—Å—Ç–æ–≤..."
  dotnet test PetHotel.Tests --no-build --verbosity quiet || {
    echo "‚ùå Backend —Ç–µ—Å—Ç—ã –Ω–µ –ø—Ä–æ–π–¥–µ–Ω—ã!"
    exit 1
  }
  echo "‚úÖ [Backend] –í—Å–µ —Ç–µ—Å—Ç—ã –ø—Ä–æ–π–¥–µ–Ω—ã"
  echo ""
else
  echo "‚ÑπÔ∏è  [Backend] –ù–µ—Ç –∏–∑–º–µ–Ω–µ–Ω–Ω—ã—Ö C# —Ñ–∞–π–ª–æ–≤, –ø—Ä–æ–ø—É—Å–∫–∞–µ–º –ø—Ä–æ–≤–µ—Ä–∫–∏"
  echo ""
fi

echo "üéâ ‚úÖ –í—Å–µ –ø—Ä–æ–≤–µ—Ä–∫–∏ —É—Å–ø–µ—à–Ω–æ –ø—Ä–æ–π–¥–µ–Ω—ã!"
